{% extends "models/page.basic.html" %}
{% from 'macros/navmenu.html' import navmenu %}
{% from 'macros/selectors.html' import selectors %}
{% from 'macros/params.html' import params %}

{% set nav_filter='active' %}

{% if key %}
{% set title=profile.args.name + ' (change data source)' %}
{% else %}
{% set title='New HXL data source' %}
{% endif %}

{% block menu %}
{{ navmenu(profile, key=key, facet='edit') }}
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% set filter_count = 7 %}
{% block main %}
    <main>
      <h1>{{ title }}</h1>

      {% if key %}
      {% set method="POST" %}
      {% set action="/actions/save-profile" %}
      {% else %}
      {% set method="GET" %}
      {% set action="/data/edit" %}
      {% endif %}
      <form action="{{ action }}" method="{{ method }}">

        <fieldset class="panel panel-default">
          {% if key %}
          <div class="panel-heading">
            <h2><a class="collapsed" data-toggle="collapse" href="#settings-collapse">Settings</a></h2>
          </div>
          {% endif %}
          <div id="settings-collapse" class="{% if key %}panel-collapse collapse{% endif %}">
            <div class="panel-body">
              <div class="form-group required">
                <label for="url">HXL dataset URL</label>
                <input id='dataset-url' class="form-control" name="url" type="url" required="required" value="{{ profile.args.url }}" placeholder="http://example.org/dataset.csv" />
                {{ selectors('#dataset-url', true) }}
              </div>

              {% include 'snippets/filters/tagger.html' %}

              <div class="form-group pull-right">
                <button class="btn btn-success" type="submit">Next</button>
              </div>

              {% if key %}
              <input type="hidden" name="key" value="{{ key }}" />

              <div class="form-group required">
                <label for="name">Filter name</label>
                <input class="form-control" name="name" required="required" value="{{ profile.name|default('') }}"/>
              </div>

              <div class="form-group">
                <label for="description">Filter description</label>
                <textarea name="description" class="form-control">{{ profile.description|default('') }}</textarea>
              </div>

              <div class="form-group">
                <label for="schema_url">Default schema URL (for validation)</label>
                <input class="form-control" type="url" id="schema_url" name="schema_url" value="{{ profile.args.schema_url|nonone }}" />
                {{ selectors('#schema_url') }}
              </div>

              <div class="checkbox">
                <label>
                  <input name="cloneable" type="checkbox"{% if profile.cloneable %} checked="checked"{% endif %} />
                  Cloning allowed (will expose original URL)
                </label>
              </div>

              <div class="form-group">
                <label for="new-password">New password</label>
                <input class="form-control" name="new-password" type="password" />
              </div>

              <div class="form-group">
                <label for="password-repeat">Repeat new password</label>
                <input class="form-control" name="password-repeat" type="password" />
              </div>
              {% endif %}

            </div>
          </div>
        </fieldset>

        {{ params('key', 'url') }}

      </form>
    </main>
{% endblock %}

{% block scripts %}
{{ super() }}
    <script src="{{ static('hxl-proxy/hxl-proxy.js') }}"></script>
    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="sm6okywskgdecv9"></script>
    <script src="http://davidmegginson.github.io/hdx-chooser/hdx.js"></script>
    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
    <script>
      hxl_proxy.setupForm();
      $(document).ready(function() {

          // add the preview warning, with total row count
          $("#preview-warning").insertBefore($("#preview-table"));

          // Remove empty GET parameters to keep URLs shorter
          $('#filter-form').submit(function () {
              var text = $(this).find(":input").filter(function () {
                  return $.trim(this.value).length > 0
              }).serialize();
              window.location = '?' + text;
              return false;
          });
              
      });
    </script>
{% endblock %}
