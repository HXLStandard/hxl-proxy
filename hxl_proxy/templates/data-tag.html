<div>
  {% extends "models/page.basic.html" %}
  {% from 'macros/navmenu.html' import navmenu %}
  {% from 'macros/params.html' import params %}
  {% from 'macros/edittabs.html' import edittabs %}

  {% set nav_filter='active' %}

  {% block menu %}
  {{ navmenu(profile, key=key, facet='source') }}
  {% endblock %}

  {% block title %}Add HXL tags{% endblock %}

  {% block main %}
  <div>

    {% if using_tagger_p(profile) %}
    {{ edittabs(profile, key, 'tagger') }}
    {% endif %}
    
    <h1>Add HXL tags</h1>

    {% include "snippets/source.html" %}

    {% if not using_tagger_p(profile) %}
    <p class="alert alert-warning">
      We can't find any <a href="http://hxlstandard.org">HXL
      hashtags</a> in your data, but all is not lost!  You can define
      tags to go with your headers below, and the HXL Proxy will add
      them automatically.
    </p>
    {% endif %}

    {% if not header_row %}

    <p class="lead">First, select the <b>last header row</b> before the data starts.</p>

    <table class="table">
      {% for row in preview %}
      <tr>
        <td>
          <form method="GET" action="">
            <input type="hidden" name="header-row" value="{{ loop.index }}" />
            {% if key %}
            {{ params(profile.args) }}
            {% endif %}
            {{ params(request.args) }}
            <button class="btn btn-default">Row {{ loop.index }}</button>
          </form>
        </td>
        {% for value in row %}
        <td>{{ value }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </table>

    {% else %}

    <p class="lead">Pick HXL tags for some or all of your headers.</p>

    <form class="panel-body" action="/data/edit" method="GET">

      <div class="panel-body">
        {% import 'snippets/filters/filter-variables.j2' as vars %}
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Header (sub)string</th>
              <th>HXL hashtag</th>
            </tr>
            <tr>
              <td><i>E.g.</i></td>
              <td><code>Province</code></td>
              <td><code>#adm1</code></td>
            </tr>
          </thead>
          <tbody>
            {% for value in preview[header_row-1] %}
            {% set name='tagger-%02d' % loop.index %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                <input class="form-control" name="{{ name + '-header' }}"
                       value="{{ profile.args[name + '-header'] or value|strnorm }}"
                       placeholder="Header text" />
              </td>
              <td>
                <input class="form-control" name="{{ name + '-tag' }}"
                       value="{{ profile.args[name + '-tag'] }}"
                       pattern="^{{ vars.tag_pattern }}$" title="{{ vars.tag_help }}"
                       placeholder="{{ vars.tag_placeholder }}" />
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="form-group">
        <button class="btn btn-success" type="submit">Next</button>
      </div>

      {% if key %}
      {{ params(profile.args) }}
      {% endif %}
      {{ params(request.args) }}

    </form>
    {% endif %}
  </div>
  {% endblock %}

  {% block scripts %}
  {{ super() }}
  <script src="{{ static('hxl-proxy/hxl-proxy.js') }}"></script>
  <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="sm6okywskgdecv9"></script>
  {% endblock %}
</div>
